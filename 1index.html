<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>قارئ بطاقات المستثمرين</title>
    <style>
        /* الأنماط العامة */
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --gray-color: #95a5a6;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            direction: rtl;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--dark-color);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            margin: 0;
            font-size: 24px;
        }
        
        /* أنماط قسم القراءة */
        .card-reader {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .reader-options {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .option-btn {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .option-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .option-btn.camera {
            background-color: var(--secondary-color);
        }
        
        .option-btn i {
            font-size: 20px;
        }
        
        /* أنماط قارئ الكاميرا */
        .camera-reader {
            display: none;
            position: relative;
            width: 100%;
            height: 350px;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .camera-reader.active {
            display: block;
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .scanner-frame {
            width: 250px;
            height: 250px;
            border: 3px solid #fff;
            border-radius: 20px;
            box-shadow: 0 0 0 100vw rgba(0, 0, 0, 0.5);
            position: relative;
        }
        
        .scanner-line {
            position: absolute;
            top: 0;
            left: 10px;
            right: 10px;
            height: 2px;
            background-color: var(--primary-color);
            box-shadow: 0 0 8px var(--primary-color);
            animation: scan 2s linear infinite;
        }
        
        @keyframes scan {
            0% { top: 10px; }
            50% { top: calc(100% - 10px); }
            100% { top: 10px; }
        }
        
        /* أنماط محمل الملفات */
        .file-uploader {
            display: none;
            border: 2px dashed var(--gray-color);
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .file-uploader.active {
            display: block;
        }
        
        .file-uploader.drag-over {
            border-color: var(--primary-color);
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .file-uploader i {
            font-size: 48px;
            color: var(--gray-color);
            margin-bottom: 15px;
        }
        
        .file-uploader p {
            margin: 10px 0;
            color: var(--dark-color);
            font-size: 16px;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .upload-btn:hover {
            background-color: #2980b9;
        }
        
        /* أنماط عرض النتائج */
        .results {
            display: none;
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .results.active {
            display: block;
        }
        
        .card-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .investor-card {
            width: 350px;
            height: 220px;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            margin: 0 auto;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .investor-card.premium {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
        }
        
        .investor-card.gold {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        .investor-card.platinum {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }
        
        .card-shimmer {
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: 100%; }
        }
        
        .card-content {
            position: relative;
            height: 100%;
            padding: 20px;
            color: white;
            z-index: 1;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .card-logo {
            width: 60px;
            height: 35px;
            background: white;
            border-radius: 5px;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .card-chip-container {
            position: absolute;
            top: 60px;
            left: 30px;
        }
        
        .card-chip {
            width: 50px;
            height: 40px;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .chip-lines {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 35px;
            height: 25px;
            border: 2px solid rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        
        .card-type-icon {
            font-size: 24px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .card-qr-container {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 5px;
            border-radius: 8px;
            width: 80px;
            height: 80px;
        }
        
        .card-nfc-indicator {
            position: absolute;
            top: 50%;
            right: 30px;
            transform: translateY(-50%) rotate(90deg);
            color: rgba(255, 255, 255, 0.6);
            font-size: 20px;
        }
        
        .card-number {
            font-size: 20px;
            letter-spacing: 3px;
            margin-top: 60px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            font-family: 'Courier New', monospace;
        }
        
        .card-details {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
        }
        
        .card-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.7;
            margin-bottom: 5px;
        }
        
        .card-value {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 1px;
        }
        
        .card-footer {
            position: absolute;
            bottom: 10px;
            right: 20px;
            text-align: right;
        }
        
        .card-bank-name {
            font-size: 10px;
            opacity: 0.6;
        }
        
        .card-type-name {
            font-size: 12px;
            font-weight: 600;
            margin-top: 3px;
        }
        
        .card-details-container {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .card-details-container h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--dark-color);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .info-item {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .info-item label {
            display: block;
            font-size: 14px;
            color: var(--gray-color);
            margin-bottom: 5px;
        }
        
        .info-item div {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        /* أنماط الرسائل */
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .message.success {
            background-color: rgba(46, 204, 113, 0.2);
            color: #27ae60;
        }
        
        .message.error {
            background-color: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        
        .message.warning {
            background-color: rgba(243, 156, 18, 0.2);
            color: #f39c12;
        }
        
        .message.info {
            background-color: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }
        
        .message i {
            font-size: 20px;
        }
        
        /* أنماط الإشعارات */
        #notifications-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 300px;
        }
        
        .notification {
            background-color: white;
            border-right: 4px solid;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transform: translateX(120%);
            transition: transform 0.3s ease;
            position: relative;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            border-color: var(--secondary-color);
        }
        
        .notification.error {
            border-color: var(--danger-color);
        }
        
        .notification.warning {
            border-color: var(--warning-color);
        }
        
        .notification.info {
            border-color: var(--primary-color);
        }
        
        .notification h4 {
            margin: 0 0 5px;
            font-size: 16px;
        }
        
        .notification p {
            margin: 0;
            font-size: 14px;
            opacity: 0.8;
        }
        
        .notification-progress {
            position: absolute;
            bottom: 0;
            right: 0;
            height: 3px;
            width: 100%;
            transition: width 5s linear;
        }
        
        .notification.success .notification-progress {
            background-color: var(--secondary-color);
        }
        
        .notification.error .notification-progress {
            background-color: var(--danger-color);
        }
        
        .notification.warning .notification-progress {
            background-color: var(--warning-color);
        }
        
        .notification.info .notification-progress {
            background-color: var(--primary-color);
        }
        
        /* أنماط محمل */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* أنماط أخرى */
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-light {
            background-color: var(--light-color);
            color: var(--dark-color);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* التوافق مع الأجهزة المحمولة */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            header {
                padding: 15px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .card-reader, .results {
                padding: 15px;
            }
            
            .investor-card {
                width: 300px;
                height: 190px;
            }
            
            .card-number {
                font-size: 16px;
                margin-top: 50px;
            }
            
            .card-chip {
                width: 40px;
                height: 32px;
            }
            
            .card-qr-container {
                width: 60px;
                height: 60px;
            }
        }
    </style>
    <!-- إضافة الخطوط والأيقونات -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>قارئ بطاقات المستثمرين</h1>
            <p>قم بمسح رمز QR أو تحميل صورة للبطاقة للتعرف عليها</p>
        </header>
        
        <div class="card-reader">
            <div class="reader-options">
                <button class="option-btn camera" onclick="startCamera()">
                    <i class="fas fa-camera"></i>
                    استخدم الكاميرا
                </button>
                <button class="option-btn" onclick="showFileUploader()">
                    <i class="fas fa-upload"></i>
                    تحميل صورة
                </button>
            </div>
            
            <div id="cameraReader" class="camera-reader">
                <video id="video" playsinline autoplay></video>
                <div class="scanner-overlay">
                    <div class="scanner-frame">
                        <div class="scanner-line"></div>
                    </div>
                </div>
                <div id="cameraControls" style="position: absolute; bottom: 10px; left: 10px; display: flex; gap: 10px;">
                    <button class="btn btn-light" onclick="switchCamera()" style="padding: 8px; border-radius: 50%;">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn btn-light" onclick="toggleFlash()" style="padding: 8px; border-radius: 50%;">
                        <i class="fas fa-bolt"></i>
                    </button>
                </div>
            </div>
            
            <div id="fileUploader" class="file-uploader">
                <i class="fas fa-file-image"></i>
                <p>اسحب وأفلت صورة رمز QR هنا</p>
                <p>أو</p>
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">اختر ملفاً</button>
                <input type="file" id="fileInput" class="file-input" accept="image/*" onchange="handleFileSelect(this.files)">
            </div>
        </div>
        
        <div id="loadingMessage" class="message info" style="display: none;">
            <div class="loader"></div>
            <span>جاري معالجة الصورة...</span>
        </div>
        
        <div id="errorMessage" class="message error" style="display: none;">
            <i class="fas fa-exclamation-circle"></i>
            <span>حدث خطأ أثناء قراءة الرمز</span>
        </div>
        
        <div id="results" class="results">
            <div class="message success">
                <i class="fas fa-check-circle"></i>
                <span>تم التعرف على البطاقة بنجاح!</span>
            </div>
            
            <div class="card-container">
                <div id="cardPreview" class="investor-card">
                    <!-- سيتم تعبئة هذا القسم بالجافاسكريبت -->
                </div>
            </div>
            
            <div id="cardDetails" class="card-details-container">
                <h3>معلومات البطاقة</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <label>معرف البطاقة</label>
                        <div id="cardId">-</div>
                    </div>
                    <div class="info-item">
                        <label>رقم البطاقة</label>
                        <div id="cardNumber">-</div>
                    </div>
                    <div class="info-item">
                        <label>نوع البطاقة</label>
                        <div id="cardType">-</div>
                    </div>
                    <div class="info-item">
                        <label>تاريخ الانتهاء</label>
                        <div id="cardExpiry">-</div>
                    </div>
                </div>
                
                <h3>معلومات المستثمر</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <label>معرف المستثمر</label>
                        <div id="investorId">-</div>
                    </div>
                    <div class="info-item">
                        <label>اسم المستثمر</label>
                        <div id="investorName">-</div>
                    </div>
                </div>
                
                <div id="additionalInfo"></div>
            </div>
            
            <div class="actions">
                <button class="btn btn-primary" onclick="scanAgain()">
                    <i class="fas fa-qrcode"></i>
                    مسح جديد
                </button>
                <button class="btn btn-secondary" onclick="getDetailedInfo()">
                    <i class="fas fa-info-circle"></i>
                    معلومات مفصلة
                </button>
            </div>
        </div>
    </div>
    
    <div id="notifications-container"></div>
    
    <!-- إضافة مكتبات القراءة -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <!-- إضافة مكتبات Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>
    
    <script>
        // إعدادات Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDGpAHia_wEmrhnmYjrPf1n1TrAzwEMiAI",
            authDomain: "messageemeapp.firebaseapp.com",
            databaseURL: "https://messageemeapp-default-rtdb.firebaseio.com",
            projectId: "messageemeapp",
            storageBucket: "messageemeapp.appspot.com",
            messagingSenderId: "255034474844",
            appId: "1:255034474844:web:5e3b7a6bc4b2fb94cc4199"
        };

        // تهيئة Firebase
        let firebaseApp;
        let firebaseDB;
        
        try {
            if (!firebase.apps.length) {
                firebaseApp = firebase.initializeApp(firebaseConfig);
            } else {
                firebaseApp = firebase.app();
            }
            firebaseDB = firebase.database();
            console.log("✅ تم تهيئة Firebase بنجاح");
        } catch (error) {
            console.error("❌ خطأ في تهيئة Firebase:", error);
            createNotification('خطأ', 'فشل في الاتصال بقاعدة البيانات', 'error');
        }

        // متغيرات عالمية
        let video = document.getElementById('video');
        let currentStream;
        let hasFrontCamera = false;
        let hasBackCamera = false;
        let currentFacingMode = 'environment';
        let flashEnabled = false;

        // بدء الكاميرا
        async function startCamera() {
            try {
                // إظهار قارئ الكاميرا
                document.getElementById('cameraReader').classList.add('active');
                document.getElementById('fileUploader').classList.remove('active');
                
                // الحصول على قائمة الكاميرات
                await detectCameras();
                
                // بدء تدفق الكاميرا
                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
                
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                
                // بدء التعرف على رمز QR
                startQRDetection();
                
                // إظهار إشعار
                createNotification('نجاح', 'تم تشغيل الكاميرا بنجاح', 'success');
            } catch (error) {
                console.error("❌ خطأ في الوصول للكاميرا:", error);
                createNotification('خطأ', 'فشل في الوصول للكاميرا: ' + error.message, 'error');
            }
        }

        // إظهار محمل الملفات
        function showFileUploader() {
            document.getElementById('cameraReader').classList.remove('active');
            document.getElementById('fileUploader').classList.add('active');
            
            // إيقاف الكاميرا إذا كانت قيد التشغيل
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            // إعداد منطقة السحب والإفلات
            const fileUploader = document.getElementById('fileUploader');
            
            fileUploader.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploader.classList.add('drag-over');
            });
            
            fileUploader.addEventListener('dragleave', () => {
                fileUploader.classList.remove('drag-over');
            });
            
            fileUploader.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploader.classList.remove('drag-over');
                
                if (e.dataTransfer.files.length) {
                    handleFileSelect(e.dataTransfer.files);
                }
            });
        }

        // اكتشاف الكاميرات المتاحة
        async function detectCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                hasFrontCamera = videoDevices.some(device => 
                    device.label.toLowerCase().includes('front') || 
                    device.label.toLowerCase().includes('أمامية') ||
                    device.label.toLowerCase().includes('selfie'));
                    
                hasBackCamera = videoDevices.some(device => 
                    device.label.toLowerCase().includes('back') || 
                    device.label.toLowerCase().includes('خلفية') ||
                    device.label.toLowerCase().includes('rear'));
                
                // إذا كان لدينا كاميرا خلفية، فاستخدمها افتراضياً
                if (hasBackCamera) {
                    currentFacingMode = 'environment';
                } else if (hasFrontCamera) {
                    currentFacingMode = 'user';
                }
                
                console.log(`✅ تم اكتشاف ${videoDevices.length} كاميرا. أمامية: ${hasFrontCamera}, خلفية: ${hasBackCamera}`);
            } catch (error) {
                console.error("❌ خطأ في اكتشاف الكاميرات:", error);
            }
        }

        // تبديل الكاميرا
        async function switchCamera() {
            if (!(hasFrontCamera && hasBackCamera)) {
                createNotification('تنبيه', 'لا يوجد كاميرات متعددة', 'warning');
                return;
            }
            
            // تبديل الوضع
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            
            // إعادة تشغيل الكاميرا
            startCamera();
        }

        // تبديل الفلاش
        async function toggleFlash() {
            try {
                if (!currentStream) return;
                
                const track = currentStream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();
                
                // التحقق من دعم الفلاش
                if (!capabilities.torch) {
                    createNotification('تنبيه', 'الكاميرا لا تدعم الفلاش', 'warning');
                    return;
                }
                
                flashEnabled = !flashEnabled;
                await track.applyConstraints({
                    advanced: [{ torch: flashEnabled }]
                });
                
                // تحديث زر الفلاش
                const flashButton = document.querySelector('#cameraControls .fa-bolt').parentElement;
                if (flashEnabled) {
                    flashButton.style.backgroundColor = '#f39c12';
                } else {
                    flashButton.style.backgroundColor = '';
                }
            } catch (error) {
                console.error("❌ خطأ في تبديل الفلاش:", error);
                createNotification('خطأ', 'فشل في تبديل الفلاش', 'error');
            }
        }

        // بدء التعرف على رمز QR
        function startQRDetection() {
            if (!video) return;
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            function scan() {
                if (!video.videoWidth) {
                    requestAnimationFrame(scan);
                    return;
                }
                
                // ضبط حجم الـ canvas ليتطابق مع حجم الفيديو
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // رسم إطار من الفيديو على الـ canvas
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // الحصول على بيانات الصورة
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // التعرف على رمز QR باستخدام jsQR
                if (typeof jsQR === 'function') {
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code) {
                        // وجدنا رمز QR
                        console.log("✅ تم التعرف على رمز QR:", code.data);
                        
                        // اهتزاز للإشارة إلى النجاح
                        if (navigator.vibrate) {
                            navigator.vibrate([100, 50, 100]);
                        }
                        
                        // معالجة البيانات
                        handleScannedData(code.data);
                        
                        // إيقاف الكاميرا
                        if (currentStream) {
                            currentStream.getTracks().forEach(track => track.stop());
                            currentStream = null;
                        }
                        
                        return;
                    }
                }
                
                // استمرار المسح ما دامت الكاميرا تعمل
                if (currentStream) {
                    requestAnimationFrame(scan);
                }
            }
            
            scan();
        }

        // معالجة ملف تم اختياره
        function handleFileSelect(files) {
            if (!files || !files.length) return;
            
            const file = files[0];
            
            // التحقق من أن الملف هو صورة
            if (!file.type.startsWith('image/')) {
                createNotification('خطأ', 'الرجاء اختيار ملف صورة', 'error');
                return;
            }
            
            // إظهار رسالة التحميل
            document.getElementById('loadingMessage').style.display = 'flex';
            
            // إخفاء الرسائل الأخرى
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('results').classList.remove('active');
            
            // قراءة الملف
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                try {
                    const img = new Image();
                    
                    img.onload = () => {
                        // إنشاء canvas لمعالجة الصورة
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // ضبط حجم الـ canvas ليتطابق مع حجم الصورة
                        canvas.width = img.width;
                        canvas.height = img.height;
                        
                        // رسم الصورة على الـ canvas
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // الحصول على بيانات الصورة
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        
                        // التعرف على رمز QR باستخدام jsQR
                        if (typeof jsQR === 'function') {
                            const code = jsQR(imageData.data, imageData.width, imageData.height);
                            
                            if (code) {
                                // وجدنا رمز QR
                                console.log("✅ تم التعرف على رمز QR من الصورة:", code.data);
                                
                                // إخفاء رسالة التحميل
                                document.getElementById('loadingMessage').style.display = 'none';
                                
                                // معالجة البيانات
                                handleScannedData(code.data);
                            } else {
                                throw new Error('لم يتم العثور على رمز QR في الصورة');
                            }
                        } else {
                            throw new Error('مكتبة jsQR غير متاحة');
                        }
                    };
                    
                    img.onerror = () => {
                        throw new Error('فشل في تحميل الصورة');
                    };
                    
                    img.src = e.target.result;
                } catch (error) {
                    console.error("❌ خطأ في قراءة الصورة:", error);
                    
                    // إخفاء رسالة التحميل وإظهار رسالة الخطأ
                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('errorMessage').style.display = 'flex';
                    document.getElementById('errorMessage').querySelector('span').textContent = `حدث خطأ: ${error.message}`;
                    
                    // إظهار إشعار
                    createNotification('خطأ', `فشل في قراءة الصورة: ${error.message}`, 'error');
                }
            };
            
            reader.onerror = () => {
                console.error("❌ خطأ في قراءة الملف");
                
                // إخفاء رسالة التحميل وإظهار رسالة الخطأ
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'flex';
                
                // إظهار إشعار
                createNotification('خطأ', 'فشل في قراءة الملف', 'error');
            };
            
            reader.readAsDataURL(file);
        }

        // معالجة البيانات الممسوحة
        function handleScannedData(data) {
            try {
                console.log("⏳ جاري معالجة البيانات الممسوحة:", data);
                
                // تحليل البيانات
                const cardData = JSON.parse(data);
                
                // التحقق من صحة البيانات - دعم كل من التنسيق القديم والجديد
                let cardId = cardData.cardId || cardData.id;
                let investorId = cardData.investorId || cardData.inv;
                let cardNumber = cardData.cardNumber || cardData.num;
                let cardType = cardData.cardType || cardData.t;
                let expiryDate = cardData.expiryDate || cardData.exp;
                let status = cardData.status || cardData.s;
                
                if (!cardId || !investorId) {
                    throw new Error('بيانات البطاقة غير صالحة');
                }
                
                // التحقق من البيانات في Firebase إذا كان متاحاً
                if (firebaseDB) {
                    getCardFromFirebase(cardId, investorId).then(firebaseData => {
                        if (firebaseData) {
                            // استخدام بيانات Firebase
                            displayCardDetails({
                                ...cardData,
                                ...firebaseData,
                                cardId: cardId || firebaseData.id,
                                investorId: investorId || firebaseData.investorId,
                                cardNumber: cardNumber || firebaseData.number,
                                cardType: cardType || firebaseData.type,
                                expiryDate: expiryDate || firebaseData.expiry,
                                status: status || firebaseData.status
                            });
                        } else {
                            // استخدام البيانات المحلية
                            displayCardDetails(cardData);
                        }
                    }).catch(error => {
                        console.error("❌ خطأ في الحصول على بيانات Firebase:", error);
                        // استخدام البيانات المحلية
                        displayCardDetails(cardData);
                    });
                } else {
                    // استخدام البيانات المحلية
                    displayCardDetails(cardData);
                }
                
                // إظهار إشعار
                createNotification('نجاح', 'تم التعرف على البطاقة بنجاح', 'success');
            } catch (error) {
                console.error('❌ خطأ في معالجة البيانات الممسوحة:', error);
                
                // إخفاء رسالة التحميل وإظهار رسالة الخطأ
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'flex';
                document.getElementById('errorMessage').querySelector('span').textContent = `حدث خطأ: ${error.message}`;
                
                // إظهار إشعار
                createNotification('خطأ', `فشل في معالجة البيانات: ${error.message}`, 'error');
            }
        }

        // الحصول على بيانات البطاقة من Firebase
        async function getCardFromFirebase(cardId, investorId) {
            try {
                // البحث في مسار cards
                const cardSnapshot = await firebaseDB.ref(`cards/${cardId}`).once('value');
                let cardData = cardSnapshot.val();
                
                if (!cardData) {
                    // البحث في مسار investorCards
                    const invCardSnapshot = await firebaseDB.ref(`investorCards/${cardId}`).once('value');
                    cardData = invCardSnapshot.val();
                }
                
                if (cardData) {
                    // البحث عن بيانات المستثمر
                    const investorSnapshot = await firebaseDB.ref(`investors/${investorId}`).once('value');
                    const investorData = investorSnapshot.val();
                    
                    if (investorData) {
                        return {
                            ...cardData,
                            investor: investorData
                        };
                    }
                    
                    return cardData;
                }
                
                return null;
            } catch (error) {
                console.error("❌ خطأ في الحصول على بيانات Firebase:", error);
                return null;
            }
        }

        // الحصول على معلومات مفصلة
        function getDetailedInfo() {
            // هذه الوظيفة يمكن استخدامها للحصول على معلومات أكثر تفصيلاً
            // مثل المعاملات الأخيرة، تفاصيل الاستثمار، إلخ
            createNotification('معلومات', 'جاري الحصول على معلومات مفصلة...', 'info');
            
            // يمكن إضافة المزيد من الوظائف هنا للحصول على بيانات من Firebase
        }

        // عرض تفاصيل البطاقة
        function displayCardDetails(cardData) {
            console.log("⏳ جاري عرض تفاصيل البطاقة:", cardData);
            
            // الحصول على البيانات
            const cardId = cardData.cardId || cardData.id;
            const cardNumber = cardData.cardNumber || cardData.num;
            const cardType = cardData.cardType || cardData.t;
            const expiryDate = cardData.expiryDate || cardData.exp;
            const investorId = cardData.investorId || cardData.inv;
            const investorName = cardData.investorName || cardData.investor?.name || 'غير معروف';
            
            // تحديث عناصر واجهة المستخدم
            document.getElementById('cardId').textContent = cardId;
            document.getElementById('cardNumber').textContent = formatCardNumber(cardNumber);
            document.getElementById('cardType').textContent = getCardTypeName(cardType);
            document.getElementById('cardExpiry').textContent = formatExpiry(expiryDate);
            document.getElementById('investorId').textContent = investorId;
            document.getElementById('investorName').textContent = investorName;
            
            // إنشاء معاينة البطاقة
            const cardPreview = document.getElementById('cardPreview');
            cardPreview.className = `investor-card ${cardType}`;
            cardPreview.innerHTML = `
                <div class="card-shimmer"></div>
                <div class="card-content">
                    <div class="card-header">
                        <div class="card-logo">
                            <div style="font-size: 12px; font-weight: bold; color: #333; display: flex; 
                                        flex-direction: column; align-items: center; justify-content: center; 
                                        height: 100%; width: 100%;">
                                <i class="fas fa-landmark" style="font-size: 16px; margin-bottom: 2px;"></i>
                                <span>IIB</span>
                            </div>
                        </div>
                        <div class="card-chip-container">
                            <div class="card-chip">
                                <div class="chip-lines"></div>
                            </div>
                        </div>
                        <div class="card-type-icon">
                            <i class="fas fa-${cardType === 'platinum' ? 'gem' : cardType === 'gold' ? 'crown' : 'star'}"></i>
                        </div>
                    </div>
                    
                    <div class="card-qr-container">
                        <div style="width: 80px; height: 80px; background: #fff; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-qrcode" style="font-size: 50px; color: #333;"></i>
                        </div>
                        <div class="card-nfc-indicator">
                            <i class="fas fa-wifi"></i>
                        </div>
                    </div>
                    
                    <div class="card-number">${formatCardNumber(cardNumber)}</div>
                    
                    <div class="card-details">
                        <div class="card-holder">
                            <div class="card-label">CARD HOLDER</div>
                            <div class="card-value">${investorName.toUpperCase()}</div>
                        </div>
                        <div class="card-expiry">
                            <div class="card-label">VALID THRU</div>
                            <div class="card-value">${formatExpiry(expiryDate)}</div>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <div class="card-bank-name">بنك الاستثمار العراقي</div>
                        <div class="card-type-name">${getCardTypeName(cardType).toUpperCase()}</div>
                    </div>
                </div>
            `;
            
            // إضافة معلومات إضافية إذا كانت متاحة
            let additionalInfoHTML = '';
            
            // معلومات الاستثمار
            if (cardData.investmentData || cardData.totalInvestment) {
                const totalInvestment = cardData.investmentData?.totalInvestment || cardData.totalInvestment || 0;
                const totalProfit = cardData.investmentData?.totalProfit || cardData.totalProfit || 0;
                
                additionalInfoHTML += `
                    <h3>معلومات الاستثمار</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>إجمالي الاستثمار</label>
                            <div>${formatCurrency(totalInvestment)}</div>
                        </div>
                        <div class="info-item">
                            <label>إجمالي الأرباح</label>
                            <div>${formatCurrency(totalProfit)}</div>
                        </div>
                    </div>
                `;
            }
            
            // معلومات البطاقة الإضافية
            if (cardData.limits) {
                additionalInfoHTML += `
                    <h3>حدود البطاقة</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>الحد اليومي</label>
                            <div>${formatCurrency(cardData.limits.dailyLimit)}</div>
                        </div>
                        <div class="info-item">
                            <label>الحد الشهري</label>
                            <div>${formatCurrency(cardData.limits.monthlyLimit)}</div>
                        </div>
                        <div class="info-item">
                            <label>حد السحب</label>
                            <div>${formatCurrency(cardData.limits.withdrawalLimit)}</div>
                        </div>
                    </div>
                `;
            }
            
            // مزايا البطاقة
            if (cardData.features) {
                additionalInfoHTML += `
                    <h3>مزايا البطاقة</h3>
                    <div class="info-grid">
                `;
                
                if (cardData.features.profitBonus) {
                    additionalInfoHTML += `
                        <div class="info-item">
                            <label>مكافأة أرباح إضافية</label>
                            <div>${cardData.features.profitBonus}%</div>
                        </div>
                    `;
                }
                
                if (cardData.features.freeTransactions) {
                    additionalInfoHTML += `
                        <div class="info-item">
                            <label>معاملات مجانية</label>
                            <div>${cardData.features.freeTransactions === -1 ? 'غير محدودة' : cardData.features.freeTransactions}</div>
                        </div>
                    `;
                }
                
                if (cardData.features.prioritySupport) {
                    additionalInfoHTML += `
                        <div class="info-item">
                            <label>دعم ذو أولوية</label>
                            <div><i class="fas fa-check" style="color: var(--secondary-color);"></i></div>
                        </div>
                    `;
                }
                
                if (cardData.features.vipAccess) {
                    additionalInfoHTML += `
                        <div class="info-item">
                            <label>خدمات VIP</label>
                            <div><i class="fas fa-check" style="color: var(--secondary-color);"></i></div>
                        </div>
                    `;
                }
                
                if (cardData.features.insurance) {
                    additionalInfoHTML += `
                        <div class="info-item">
                            <label>تأمين على المعاملات</label>
                            <div><i class="fas fa-check" style="color: var(--secondary-color);"></i></div>
                        </div>
                    `;
                }
                
                additionalInfoHTML += `
                    </div>
                `;
            }
            
            // معلومات النظام
            additionalInfoHTML += `
                <h3>معلومات النظام</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <label>حالة البطاقة</label>
                        <div class="status ${cardData.status || 'active'}">${cardData.status === 'suspended' ? 'متوقفة' : 'نشطة'}</div>
                    </div>
                    <div class="info-item">
                        <label>آخر تحديث</label>
                        <div>${formatDate(cardData.lastSync || cardData.updatedAt || cardData.timestamp || new Date().toISOString())}</div>
                    </div>
                </div>
            `;
            
            // إضافة المعلومات الإضافية
            document.getElementById('additionalInfo').innerHTML = additionalInfoHTML;
            
            // إظهار النتائج
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('results').classList.add('active');
        }

        // إعادة المسح
        function scanAgain() {
            // إخفاء النتائج
            document.getElementById('results').classList.remove('active');
            document.getElementById('errorMessage').style.display = 'none';
            
            // إظهار قارئ البطاقة
            document.getElementById('cameraReader').classList.remove('active');
            document.getElementById('fileUploader').classList.remove('active');
            
            // إعادة تعيين واجهة المستخدم
            document.getElementById('cameraReader').classList.remove('active');
            document.getElementById('fileUploader').classList.remove('active');
            
            // استخدام الكاميرا تلقائياً
            startCamera();
        }

        // إنشاء إشعار
        function createNotification(title, message, type = 'info') {
            // التحقق من وجود div الإشعارات
            let notificationsContainer = document.getElementById('notifications-container');
            
            if (!notificationsContainer) {
                notificationsContainer = document.createElement('div');
                notificationsContainer.id = 'notifications-container';
                document.body.appendChild(notificationsContainer);
            }
            
            // إنشاء الإشعار
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: flex-start;">
                    <div style="margin-left: 10px; color: var(--${type === 'success' ? 'secondary' : type}-color);">
                        <i class="fas fa-${
                            type === 'success' ? 'check-circle' : 
                            type === 'warning' ? 'exclamation-triangle' : 
                            type === 'error' ? 'exclamation-circle' : 
                            'info-circle'
                        }" style="font-size: 18px;"></i>
                    </div>
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 5px; font-size: 16px;">${title}</h4>
                        <p style="margin: 0; font-size: 14px; opacity: 0.8;">${message}</p>
                    </div>
                    <button style="background: none; border: none; cursor: pointer; font-size: 16px; color: #999; margin-right: 5px;" onclick="this.parentElement.parentElement.remove()">
                        &times;
                    </button>
                </div>
                <div class="notification-progress" style="position: absolute; bottom: 0; right: 0; height: 3px; width: 100%; background-color: var(--${type === 'success' ? 'secondary' : type}-color); opacity: 0.7;"></div>
            `;
            
            // إضافة الإشعار إلى الحاوية
            notificationsContainer.appendChild(notification);
            
            // إظهار الإشعار
            setTimeout(() => {
                notification.classList.add('show');
                
                // إخفاء الإشعار بعد 5 ثوانٍ
                const progressBar = notification.querySelector('.notification-progress');
                progressBar.style.width = '0';
                
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, 5000);
            }, 10);
        }

        // تنسيق رقم البطاقة
        function formatCardNumber(number) {
            if (!number) return '-';
            return number.replace(/(\d{4})/g, '$1 ').trim();
        }

        // تنسيق تاريخ الانتهاء
        function formatExpiry(date) {
            if (!date) return '-';
            
            if (date.includes('-')) {
                const parts = date.split('-');
                return `${parts[1]}/${parts[0].substring(2)}`;
            }
            
            return date;
        }

        // الحصول على اسم نوع البطاقة
        function getCardTypeName(type) {
            switch (type) {
                case 'platinum': return 'بلاتينية';
                case 'gold': return 'ذهبية';
                case 'premium': return 'بريميوم';
                default: return type || 'قياسية';
            }
        }

        // تنسيق المبلغ
        function formatCurrency(amount, short = false) {
            if (amount === undefined || amount === null) return '-';
            
            amount = Number(amount);
            
            if (isNaN(amount)) return '-';
            
            if (short && amount >= 1000000) {
                return `${(amount / 1000000).toFixed(1)} مليون`;
            }
            
            return new Intl.NumberFormat('ar-IQ', {
                style: 'currency',
                currency: 'IQD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // تنسيق التاريخ
        function formatDate(dateString) {
            if (!dateString) return '-';
            
            try {
                const date = new Date(dateString);
                
                if (isNaN(date.getTime())) return dateString;
                
                const options = { year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric' };
                return new Intl.DateTimeFormat('ar-IQ', options).format(date);
            } catch (error) {
                return dateString;
            }
        }

        // بدء التطبيق
        document.addEventListener('DOMContentLoaded', () => {
            console.log("✅ تم تحميل التطبيق بنجاح");
            
            // التحقق من دعم كاميرا الويب
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                console.warn("⚠️ الكاميرا غير مدعومة في هذا المتصفح");
                
                // إخفاء زر الكاميرا
                document.querySelector('.option-btn.camera').style.display = 'none';
                
                // إظهار محمل الملفات تلقائياً
                showFileUploader();
            }
            
            // التحقق من دعم مكتبة jsQR
            if (typeof jsQR !== 'function') {
                console.warn("⚠️ مكتبة jsQR غير متاحة");
                
                // تحميل مكتبة jsQR
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js';
                document.head.appendChild(script);
            }
        });
    </script>
</body>
</html>